#!/bin/bash

USAGE="$0 [-v] [-h] [status|start|stop|destroy|restart|reset|import] [[docker]...]"

#############
# FUNCTIONS #
#############

# source $HOME/.openagrc
source $(dirname $0)/openag.functions.sh

############################
# Check config and folders #
############################

which docker > /dev/null
if [ "$?" != 0 ]; then
    echo "You need to install docker for the dockers to work"
    echo "Check here: https://www.docker.com/get-docker"
    exit 1
fi

OAGHOME=$HOME/.openag
OAGCONF=$OAGHOME/openag.conf

# If we don't have a home then create it
if [ ! -d "$OAGHOME" ]; then
    echo "Creating openag home:"
    echo "    -> $OAGHOME"
    mkdir -p $OAGHOME
fi

# If we don't have default config write some
if [ ! -f "$OAGCONF" ]; then
    echo "Creating openag default config:"
    echo "    -> $OAGCONF"
    cat <<EOF > $OAGCONF

# These locations set where data should be persisted to. If you change these
# you need to delete the tmux.conf file above, or edit it.
PERSIST_DIR=\$OAGHOME/data
PERSIST_COVE_MEDIA=\$PERSIST_DIR/cove/media
PERSIST_COVE_UPLOAD=\$PERSIST_DIR/cove/upload
PERSIST_GEO_DATA=\$PERSIST_DIR/geocoder/data
PERSIST_GEO_UPLOADS=\$PERSIST_DIR/geocoder/uploads
PERSIST_GEO_CONF=\$PERSIST_DIR/geocoder/conf
PERSIST_DPORTAL_CACHE=\$PERSIST_DIR/dportal
EOF
fi

# Import default config
source $OAGCONF

if [ -z "$PERSIST_COVE_MEDIA" ];    then export PERSIST_COVE_MEDIA=$HOME/.openag/data/cove/media; fi
if [ -z "$PERSIST_COVE_UPLOAD" ];   then export PERSIST_COVE_UPLOAD=$HOME/.openag/data/cove/upload; fi
if [ -z "$PERSIST_GEO_DATA" ];      then export PERSIST_GEO_DATA=$HOME/.openag/data/geocoder/data; fi
if [ -z "$PERSIST_GEO_UPLOADS" ];   then export PERSIST_GEO_UPLOADS=$HOME/.openag/data/geocoder/uploads; fi
if [ -z "$PERSIST_GEO_CONF" ];      then export PERSIST_GEO_CONF=$HOME/.openag/data/geocoder/conf; fi
if [ -z "$PERSIST_DPORTAL_CACHE" ]; then export PERSIST_DPORTAL_CACHE=$HOME/.openag/data/dportal; fi

for path in $PERSIST_COVE_MEDIA $PERSIST_COVE_UPLOAD $PERSIST_GEO_DATA $PERSIST_GEO_UPLOADS $PERSIST_GEO_CONF $PERSIST_DPORTAL_CACHE; do
    if [ ! -d "$path" ]; then
        mkdir -p $path
    fi
done

if [ ! -f "$PERSIST_GEO_CONF/settings.json" ]; then
    wget -O $PERSIST_GEO_CONF/settings.json https://raw.githubusercontent.com/neontribe/AG/develop/geocoder/conf/settings.json
fi

#####################
# Process Arguments #
#####################

VERBOSE=0

while getopts "hv" options; do
	case $options in
		v) VERBOSE=1;;
		h) usage; exit 0;;
    esac
done

shift $((OPTIND-1))
ACTION=$1
if [ -z "$ACTION" ]; then
    ACTION='status'
fi

if [ $ACTION != 'status' ] && [ $ACTION != 'start' ] && [ $ACTION != 'stop' ] && [ $ACTION != 'restart' ] && [ $ACTION != 'destroy' ] && [ $ACTION != 'update' ] && [ $ACTION != 'reset' ] && [ $ACTION != 'import' ]; then
	echo $USAGE
	exit 1;
fi

###########
# ACTIONS #
###########

DOCKERS=`echo $@ | sed -e 's/^\w*\ *//'`
IDS=
for DOCKER in $DOCKERS; do
    ID=$(docker ps -a -q --filter name=openag_${DOCKER} --format="{{.ID}}")
    if [ ! -z "$ID" ]; then
        IDS="$ID $IDS"
    fi
done

if [ -z "$IDS" ]; then
    IDS=$(docker ps -a -q --filter name=openag_ --format="{{.ID}}")
    IDS=$(echo $IDS | sed -e "s/\n/ /g")
fi

if [ -z "$DOCKERS" ]; then
    DOCKERS="cove geocoder autogeocoder dportal"
fi

if [ "0" != "$VERBOSE" ]; then
    echo "IDS=$IDS"
    echo "DOCKERS=$DOCKERS"
fi

case $ACTION in
    status)
      docker ps -a --filter name=openag_;;
    start)
        start_dockers $DOCKERS;;
    stop)
        stop_dockers $IDS;;
    destroy)
        destroy_dockers $IDS;;
    update)
        update_dockers $IDS;;
    reset)
        data_reset $@;;
    import)
        data_import $DOCKERS $@;;
    restart)
        stop_dockers
        start_dockers;;
esac
